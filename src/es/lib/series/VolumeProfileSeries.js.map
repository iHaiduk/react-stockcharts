{"version":3,"sources":["../../../../src/lib/series/VolumeProfileSeries.js"],"names":["React","Component","PropTypes","ascending","descending","sum","max","merge","zip","histogram","d3Histogram","nest","scaleLinear","GenericChartComponent","getAxisCanvas","head","last","hexToRGBA","accumulatingWindow","identity","functor","VolumeProfileSeries","props","renderSVG","bind","drawOnCanvas","ctx","moreProps","xAccessor","width","helper","rects","sessionBg","className","opacity","showSessionBackground","sessionBackGround","sessionBackGroundOpacity","sessionBgSvg","map","d","idx","i","x","y","w1","height","fill1","stroke1","w2","fill2","stroke2","defaultProps","bins","maxProfileWidthPercent","source","close","volume","absoluteChange","bySession","sessionStart","plotData","startOfMonth","orient","fill","type","stroke","partialStartOK","partialEndOK","realXScale","xScale","yScale","chartConfig","sessionBuilder","discardTillStart","discardTillEnd","accumulateTill","accumulator","dx","length","sessions","allRects","begin","session","finish","sessionWidth","histogram2","value","thresholds","rollup","key","direction","sortKeys","leaves","values","volumeInBins","arr","entries","volumeValues","each","base","range","start","end","domain","totalVolumes","totalVolume","volumes","totalVolumeX","ws","Math","abs","x1","x0","fillStyle","forEach","beginPath","rect","closePath","strokeStyle"],"mappings":"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","file":"VolumeProfileSeries.js","sourcesContent":["\"use strict\";\n\nimport React, { Component } from \"react\";\nimport PropTypes from \"prop-types\";\n\nimport { ascending, descending, sum, max, merge, zip, histogram as d3Histogram } from \"d3-array\";\nimport { nest } from \"d3-collection\";\nimport { scaleLinear } from \"d3-scale\";\n\nimport GenericChartComponent from \"../GenericChartComponent\";\nimport { getAxisCanvas } from \"../GenericComponent\";\n\nimport { head, last, hexToRGBA, accumulatingWindow, identity, functor } from \"../utils\";\n\nclass VolumeProfileSeries extends Component {\n\tconstructor(props) {\n\t\tsuper(props);\n\t\tthis.renderSVG = this.renderSVG.bind(this);\n\t\tthis.drawOnCanvas = this.drawOnCanvas.bind(this);\n\t}\n\tdrawOnCanvas(ctx, moreProps) {\n\t\tconst { xAccessor, width } = moreProps;\n\t\tconst { rects, sessionBg } = helper(this.props, moreProps, xAccessor, width);\n\n\t\tdrawOnCanvas(ctx, this.props, rects, sessionBg);\n\t}\n\trender() {\n\t\treturn <GenericChartComponent\n\t\t\tsvgDraw={this.renderSVG}\n\t\t\tcanvasDraw={this.drawOnCanvas}\n\t\t\tcanvasToDraw={getAxisCanvas}\n\t\t\tdrawOn={[\"pan\"]}\n\t\t/>;\n\t}\n\trenderSVG(moreProps) {\n\t\tconst { className, opacity } = this.props;\n\t\tconst { showSessionBackground, sessionBackGround, sessionBackGroundOpacity } = this.props;\n\n\t\tconst { xAccessor, width } = moreProps;\n\t\tconst { rects, sessionBg } = helper(this.props, moreProps, xAccessor, width);\n\n\t\tconst sessionBgSvg = showSessionBackground\n\t\t\t? sessionBg.map((d, idx) => <rect key={idx} {...d} opacity={sessionBackGroundOpacity} fill={sessionBackGround} />)\n\t\t\t: null;\n\n\t\treturn <g className={className}>\n\t\t\t{sessionBgSvg}\n\t\t\t{rects.map((d, i) => <g key={i}>\n\t\t\t\t<rect x={d.x} y={d.y}\n\t\t\t\t\twidth={d.w1} height={d.height}\n\t\t\t\t\tfill={d.fill1} stroke={d.stroke1} fillOpacity={opacity} />\n\t\t\t\t<rect x={d.x + d.w1} y={d.y}\n\t\t\t\t\twidth={d.w2} height={d.height}\n\t\t\t\t\tfill={d.fill2} stroke={d.stroke2} fillOpacity={opacity} />\n\t\t\t</g>)}\n\t\t</g>;\n\t}\n}\n\nVolumeProfileSeries.propTypes = {\n\tclassName: PropTypes.string,\n\topacity: PropTypes.number,\n\tshowSessionBackground: PropTypes.bool,\n\tsessionBackGround: PropTypes.string,\n\tsessionBackGroundOpacity: PropTypes.number,\n};\n\n\nVolumeProfileSeries.defaultProps = {\n\topacity: 0.5,\n\tclassName: \"line \",\n\tbins: 20,\n\tmaxProfileWidthPercent: 50,\n\tsource: d => d.close,\n\tvolume: d => d.volume,\n\tabsoluteChange: d => d.absoluteChange,\n\tbySession: false,\n\t/* eslint-disable no-unused-vars */\n\tsessionStart: ({ d, i, plotData }) => d.idx.startOfMonth,\n\t/* eslint-enable no-unused-vars */\n\torient: \"left\",\n\tfill: ({ type }) => type === \"up\" ? \"#6BA583\" : \"#FF0000\",\n\t// // fill: ({ type }) => { var c = type === \"up\" ? \"#6BA583\" : \"#FF0000\"; console.log(type, c); return c },\n\t// stroke: ({ type }) =>  type === \"up\" ? \"#6BA583\" : \"#FF0000\",\n\t// stroke: \"none\",\n\tstroke: \"#FFFFFF\",\n\tshowSessionBackground: false,\n\tsessionBackGround: \"#4682B4\",\n\tsessionBackGroundOpacity: 0.3,\n\tpartialStartOK: false,\n\tpartialEndOK: true,\n};\n\nfunction helper(props, moreProps, xAccessor, width) {\n\tconst { xScale: realXScale, chartConfig: { yScale }, plotData } = moreProps;\n\n\tconst { sessionStart, bySession, partialStartOK, partialEndOK } = props;\n\tconst { bins, maxProfileWidthPercent, source, volume, absoluteChange, orient, fill, stroke } = props;\n\n\tconst sessionBuilder = accumulatingWindow()\n\t\t.discardTillStart(!partialStartOK)\n\t\t.discardTillEnd(!partialEndOK)\n\t\t.accumulateTill((d, i) => {\n\t\t\treturn sessionStart({ d, i, plotData });\n\t\t})\n\t\t.accumulator(identity);\n\n\tconst dx = plotData.length > 1 ? realXScale(xAccessor(plotData[1])) - realXScale(xAccessor(head(plotData))) : 0;\n\n\tconst sessions = bySession ? sessionBuilder(plotData) : [plotData];\n\n\tconst allRects = sessions.map(session => {\n\n\t\tconst begin = bySession ? realXScale(xAccessor(head(session))) : 0;\n\t\tconst finish = bySession ? realXScale(xAccessor(last(session))) : width;\n\t\tconst sessionWidth = finish - begin + dx;\n\n\t\t// console.log(session)\n\n\t\t/* var histogram = d3.layout.histogram()\n\t\t\t\t.value(source)\n\t\t\t\t.bins(bins);*/\n\n\t\tconst histogram2 = d3Histogram()\n\t\t\t// .domain(xScale.domain())\n\t\t\t.value(source)\n\t\t\t.thresholds(bins);\n\n\t\t// console.log(bins, histogram(session))\n\t\t// console.log(bins, histogram2(session))\n\t\tconst rollup = nest()\n\t\t\t.key(d => d.direction)\n\t\t\t.sortKeys(orient === \"right\" ? descending : ascending)\n\t\t\t.rollup(leaves => sum(leaves, d => d.volume));\n\n\t\tconst values = histogram2(session);\n\t\t// console.log(\"values\", values)\n\n\t\tconst volumeInBins = values\n\t\t\t.map(arr => arr.map(d => absoluteChange(d) > 0 ? { direction: \"up\", volume: volume(d) } : { direction: \"down\", volume: volume(d) }))\n\t\t\t.map(arr => rollup.entries(arr));\n\n\t\t// console.log(\"volumeInBins\", volumeInBins)\n\t\tconst volumeValues = volumeInBins\n\t\t\t.map(each => sum(each.map(d => d.value)));\n\n\t\t// console.log(\"volumeValues\", volumeValues)\n\t\tconst base = xScale => head(xScale.range());\n\n\t\tconst [start, end] = orient === \"right\"\n\t\t\t? [begin, begin + sessionWidth * maxProfileWidthPercent / 100]\n\t\t\t: [finish, finish - sessionWidth * (100 - maxProfileWidthPercent) / 100];\n\n\t\tconst xScale = scaleLinear()\n\t\t\t.domain([0, max(volumeValues)])\n\t\t\t.range([start, end]);\n\n\t\t// console.log(xScale.domain())\n\n\t\tconst totalVolumes = volumeInBins.map(volumes => {\n\n\t\t\tconst totalVolume = sum(volumes, d => d.value);\n\t\t\tconst totalVolumeX = xScale(totalVolume);\n\t\t\tconst width = base(xScale) - totalVolumeX;\n\t\t\tconst x = width < 0 ? totalVolumeX + width : totalVolumeX;\n\n\t\t\tconst ws = volumes.map(d => {\n\t\t\t\treturn {\n\t\t\t\t\ttype: d.key,\n\t\t\t\t\twidth: d.value * Math.abs(width) / totalVolume,\n\t\t\t\t};\n\t\t\t});\n\n\t\t\treturn { x, ws, totalVolumeX };\n\t\t});\n\t\t// console.log(\"totalVolumes\", totalVolumes)\n\n\t\tconst rects = zip(values, totalVolumes)\n\t\t\t.map(([d, { x, ws }]) => {\n\t\t\t\tconst w1 = ws[0] || { type: \"up\", width: 0 };\n\t\t\t\tconst w2 = ws[1] || { type: \"down\", width: 0 };\n\n\t\t\t\treturn {\n\t\t\t\t\t// y: yScale(d.x + d.dx),\n\t\t\t\t\ty: yScale(d.x1),\n\t\t\t\t\t// height: yScale(d.x - d.dx) - yScale(d.x),\n\t\t\t\t\theight: yScale(d.x1) - yScale(d.x0),\n\t\t\t\t\tx,\n\t\t\t\t\twidth,\n\t\t\t\t\tw1: w1.width,\n\t\t\t\t\tw2: w2.width,\n\t\t\t\t\tstroke1: functor(stroke)(w1),\n\t\t\t\t\tstroke2: functor(stroke)(w2),\n\t\t\t\t\tfill1: functor(fill)(w1),\n\t\t\t\t\tfill2: functor(fill)(w2),\n\t\t\t\t};\n\t\t\t});\n\n\t\t// console.log(\"rects\", rects)\n\n\t\tconst sessionBg = {\n\t\t\tx: begin,\n\t\t\ty: last(rects).y,\n\t\t\theight: head(rects).y - last(rects).y + head(rects).height,\n\t\t\twidth: sessionWidth,\n\t\t};\n\n\t\treturn { rects, sessionBg };\n\t});\n\n\treturn {\n\t\trects: merge(allRects.map(d => d.rects)),\n\t\tsessionBg: allRects.map(d => d.sessionBg),\n\t};\n}\n\n\nfunction drawOnCanvas(ctx, props, rects, sessionBg) {\n\tconst { opacity, sessionBackGround, sessionBackGroundOpacity, showSessionBackground } = props;\n\n\t// var { rects, sessionBg } = helper(props, xScale, yScale, plotData);\n\n\tif (showSessionBackground) {\n\t\tctx.fillStyle = hexToRGBA(sessionBackGround, sessionBackGroundOpacity);\n\n\t\tsessionBg.forEach(each => {\n\t\t\tconst { x, y, height, width } = each;\n\n\t\t\tctx.beginPath();\n\t\t\tctx.rect(x, y, width, height);\n\t\t\tctx.closePath();\n\t\t\tctx.fill();\n\t\t});\n\t}\n\n\trects.forEach(each => {\n\t\tconst { x, y, height, w1, w2, stroke1, stroke2, fill1, fill2 } = each;\n\n\n\t\tif (w1 > 0) {\n\t\t\tctx.fillStyle = hexToRGBA(fill1, opacity);\n\t\t\tif (stroke1 !== \"none\") ctx.strokeStyle = stroke1;\n\n\t\t\tctx.beginPath();\n\t\t\tctx.rect(x, y, w1, height);\n\t\t\tctx.closePath();\n\t\t\tctx.fill();\n\n\t\t\tif (stroke1 !== \"none\") ctx.stroke();\n\t\t}\n\n\t\tif (w2 > 0) {\n\t\t\tctx.fillStyle = hexToRGBA(fill2, opacity);\n\t\t\tif (stroke2 !== \"none\") ctx.strokeStyle = stroke2;\n\n\t\t\tctx.beginPath();\n\t\t\tctx.rect(x + w1, y, w2, height);\n\t\t\tctx.closePath();\n\t\t\tctx.fill();\n\n\t\t\tif (stroke2 !== \"none\") ctx.stroke();\n\t\t}\n\n\t});\n}\n\nexport default VolumeProfileSeries;\n"]}